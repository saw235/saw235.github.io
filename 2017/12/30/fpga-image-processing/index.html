<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
      <title>Saw - Saw's Blog</title>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <meta http-equiv="content-language" content="en-gb" />
      <meta name="description" content="Saw's Blog">
      <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
      <link href="//fonts.googleapis.com/css?family=Open+Sans:400italic,400,300,700|Lora:400,700,400italic" rel="stylesheet" type="text/css">
      <link rel="stylesheet" type="text/css" href="/hikari/css/main.css" />
      <link href="atom.xml" type="application/atom+xml" rel="alternate" title="Site ATOM Feed">
  </head>

  <body>
    <!--[if lt IE 7]>
        <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
    <![endif]-->

    <div class="off-canvas">
      <figure class="avatar">
        <img src="/hikari/assets/img/avatar.jpg" alt="Picture" title="That's me, Xue Zheng.">
      </figure>
      <div class="bio">
          <h1>Hi, I'm Xue Zheng.</h1>
          <p>I enjoy programming and mathematics.</p>
      </div>
      <nav>
        <h6>Follow me on</h6>
        <ul>
          
          <li><a target="_blank" href="https://twitter.com/mx3m">Twitter</a></li>
          
          
          <li><a target="_blank" href="https://github.com/m3xm">Github</a></li>
          
          
          <li><a target="_blank" href="https://dribbble.com/m3xm">Dribbble</a></li>
          
          
          <li><a target="_blank" href="https://instagram.com/m3xm">Instagram</a></li>
          
        </ul>
      </nav>
    </div>


    <div class="site-wrapper">

      <header>
        <div class="h-wrap">
          <h1 class="title"><a href="/hikari/" title="Back to Homepage">Saw</a></h1>
          <a class="menu-icon" title="Open Bio"><span class="lines"></span></a>
        </div>
      </header>

      <main>
        <section class="single-wrap">
  <article class="single-content" itemscope itemtype="http://schema.org/BlogPosting">
    <div class="feat">
      <h5 class="page-date">
        <time datetime="2017-12-30T20:00:00+08:00" itemprop="datePublished">
          30 December 2017
        </time>
      </h5>
    </div>
    <h1 class="page-title" itemprop="name headline">Real-time Image Filtering using FPGA</h1>
    <div itemprop="articleBody">
      <p>During my undergraduate years in Penn State, one of the project I have worked on is using FPGA to do an image processing at real time. The goal of the project was to feed in video stream from a camera and be able to do edge filtering with it at real time. My motivation for this project was two fold: one, I’ve read some articles online that there were some delay issues with performing image processing at the application level and two, I was extremely interested in computer vision at the time. Anyhow, this is the results of the project.</p>

<h2 id="results">Results</h2>
<p>Repository: <a href="https://github.com/saw235/VHDL">Github</a></p>

<figure class="video_container">
  <iframe width="560" height="315" src="https://www.youtube.com/embed/Z--MAIgVxYw" frameborder="0" allowfullscreen=""></iframe>
</figure>

<p>Because the path delay of the DSP-components easily exceeds the timing contraints, a finite state machine was used to pipeline the 2D-convolution process.</p>

<p>The base images (girl and parrot) are loaded into seperate ram blocks. A 12-bit bus width is used for the ram due to the 12-bits VGA RGB ports of the Nexys4 board. A depth of 30000 is used to store a 200x150 px image.</p>

<p>Several filters such as edge-filter, sobel, gaussian blur, emboss are implemented. They can be selected using the switches located at the bottom of the board.

From right to left, the seven segment digit shows which filter the 1st stage is using, which filter the 2nd stage is using, and which image the two filter is applied on. </p>

<p><img src="/hikari/img/project_img/fpga-min.jpg" alt="Nexys4 DDR Board hooked up with a VGA display" /></p>

<div class="ImageText"> Unfiltered Parrot / Identity Filter </div>

<p><img src="/hikari/img/project_img/Parrot1-min.jpg" alt="Unfiltered Parrot" /></p>

<div class="ImageText"> Parrot with Edge filter </div>

<p><img src="/hikari/img/project_img/Parrot2-min.jpg" alt="Filtered Parrot" /></p>

<div class="ImageText"> Parrot after Blur and Edge Filter </div>

<p><img src="/hikari/img/project_img/Parrot3-min.jpg" alt="Filtered Parrot" /></p>

<div class="ImageText"> With girl image </div>

<p><img src="/hikari/img/project_img/Girl1-min.jpg" alt="Unfiltered girl" /></p>

<p><img src="/hikari/img/project_img/Girl2-min.jpg" alt="Unfiltered girl" /></p>

<div class="ImageText"> <p>With overlay image. Easily implemented by simply using a few AND and OR gates.</p><p>
See <a href="https://en.wikipedia.org/wiki/Mask_(computing)#Image_masks">https://en.wikipedia.org/wiki/Mask_(computing)#Image_masks</a></p>
</div>

<p><img src="/hikari/img/project_img/Girl3-min.jpg" alt="Unfiltered girl" /></p>

<h2 id="implementaion-details">Implementaion details</h2>
<p>Here I have included the diagrams that I thought are important to understand the implementations of the project. There are specific things like datapath of the controller units, and actual top level implementation that are left out, but those can be easily understood by going over the VHDL codes.</p>

<h3 id="top-level-explained">Top Level Explained</h3>

<p>The image below shows the Top Level overview of the filter implementation.
The entire process is fairly straightforward. From the left, the diagram shows the Image being serialized from hardcoded rom, shifted into the kernel filter for processing. The output is then loaded into a buffer and starts another filtering process and finally is outputted in VGA format.</p>

<p>A buffer is not needed but is utilized to simplify the process of two stages filtering. For example, the filters can be implemented directly to filter twice as the pixels are accumulated. The complexity involved, however, may be too much and impractical to implement.</p>

<p>As a seperate functionality, an additionaly image stored in rom can also be overlaid on top of the rom images by performing some simple operations.
The details can be read <a href="https://en.wikipedia.org/wiki/Mask_(computing)#Image_masks">here</a></p>

<p><img src="/hikari/img/project_img/Pg1_Top Level Overview.jpg" alt="Top Level Overview" class="imgfilterdiagrams" /></p>

<hr />
<h3 id="image-filtering-implementation-explained">Image Filtering Implementation Explained</h3>

<p>The three images below shows the implementation behind the sliding window image filtering method.</p>

<p>The first image shows the simplified idea of the entire process, whereas the second image shows the implementation of the sliding window in actualty.</p>

<p>You can see in this image that the 9 pixel data shifted in forms a 3x3 window. When implementing this, I included the FIFO as part of the window component so that the whole thing consist of only two components: the top part and the bottom part.</p>

<h4 id="filtering-using-a-sliding-3x3-kernel">Filtering using a sliding 3x3 kernel</h4>
<p><img src="/hikari/img/project_img/Pg2_Filtering Overview.jpg" alt="Filtering Overview" class="imgfilterdiagrams" /></p>

<h4 id="actual-implementation">Actual Implementation</h4>
<p><img src="/hikari/img/project_img/Pg3_Implementation Overview.jpg" alt="image-title-here" class="imgfilterdiagrams" /></p>

<p>The third image shows the convolution unit. In practice, this doesn’t work 100% of the time and introduces some bugs due to timing constraints caused by the DSP components (much to my dismay). To avoid that, it is necessary to implement pipelining to perform the multiplication and summation by stages. You can look up on how to do pipelining easily in VHDL by googling for it or simply uses a (Finite State Machine) FSM and think of each operation as a state. My implementation uses a FSM.</p>

<h4 id="convolution-unit">Convolution Unit</h4>
<p><img src="/hikari/img/project_img/Pg4_Convolution Unit.jpg" alt="image-title-here" class="imgfilterdiagrams" /></p>

<hr />

<h3 id="filter-controller">Filter Controller</h3>

<p>The last two images show the FSM of the controller which figures out when to start processing, when convolve the pixels, when to roll over and when to finish.</p>

<p>Again, some of the states are redundant and can be combined but are seperated for clarity and easier implementation and debugging.</p>

<p>Do remember that each of the state uses up at least one clock cycle (if no loop), however, and thus introduces delays. If your specific application is a hard real time system (ie, you need the image to be filtered within a specific amount of time), then it might not meet the requirement of the system. The same thing can be said for the pipelining process of the convolution unit.</p>

<p>What you can do at this point is to either increase the clock frequency of the board and deal with a more stringent timing requirements, or come out with a quicker algorithm which requires less clock cycle to complete a full filtering process.</p>

<p><img src="/hikari/img/project_img/Pg5_FSM KernelFilter_3x3.jpg" alt="image-title-here" class="imgfilterdiagrams" /></p>

<p><img src="/hikari/img/project_img/StateTable.PNG" alt="image-title-here" class="imgfilterdiagrams" /></p>

    </div>
    <div class="feat share">
      <a href="http://twitter.com/share" class="popup">
        <span class="icon-twitter"></span>
      </a>
    </div>
    
      <a rel="next" href="/hikari/2018/12/12/hikari-layout/" id="next">
        <span class="nav-title nav-title-next">newer</span> &rarr;
      </a>
    
    
      <a rel="prev" href="/hikari/2017/12/30/cap-cpap-mask/" id="prev">
        &larr; <span class="nav-title nav-title-prev">older</span>
      </a>
    
  </article>
</section>

      </main>

      <footer>
        <small>Powered by Jekyll - Theme: <a href="https://github.com/m3xm/hikari-for-Jekyll">hikari</a> - &copy; Xue Zheng</small>
      </footer>

    </div>
    

    <script src="/hikari/js/main.js"></script>
    
    

  </body>
</html>
